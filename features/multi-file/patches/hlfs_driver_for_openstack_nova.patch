From 28e8e26b6dd547c0d2207150e53acfceb71c9169 Mon Sep 17 00:00:00 2001
From: Harry Wei <harryxiyou@gmail.com>
Date: Sat, 23 Feb 2013 19:52:37 +0800
Subject: [PATCH] hlfs driver for Openstack Nova

---
 nova/tests/test_libvirt_volume.py |   25 +++++++++++++++++++++++++
 nova/virt/libvirt/driver.py       |    1 +
 2 files changed, 26 insertions(+)

diff --git a/nova/tests/test_libvirt_volume.py b/nova/tests/test_libvirt_volume.py
index b9f9573..aa755d0 100644
--- a/nova/tests/test_libvirt_volume.py
+++ b/nova/tests/test_libvirt_volume.py
@@ -179,6 +179,31 @@ class LibvirtVolumeTestCase(test.TestCase):
         self.assertEqual(tree.find('./source').get('name'), name)
         libvirt_driver.disconnect_volume(connection_info, "vde")
 
+    def hlfs_connection(self, volume):
+        return {
+            'driver_volume_type': 'hlfs',
+            'data': {
+                'name': volume['name']
+            }
+        }
+
+    def test_libvirt_hlfs_driver(self):
+        libvirt_driver = volume.LibvirtNetVolumeDriver(self.fake_conn)
+        name = 'volume-00000001'
+        vol = {'id': 1, 'name': name}
+        connection_info = self.hlfs_connection(vol)
+        disk_info = {
+            "bus": "virtio",
+            "dev": "vde",
+            "type": "disk",
+            }
+        conf = libvirt_driver.connect_volume(connection_info, disk_info)
+        tree = conf.format_dom()
+        self.assertEqual(tree.get('type'), 'network')
+        self.assertEqual(tree.find('./source').get('protocol'), 'hlfs')
+        self.assertEqual(tree.find('./source').get('name'), name)
+        libvirt_driver.disconnect_volume(connection_info, "vde")
+
     def rbd_connection(self, volume):
         return {
             'driver_volume_type': 'rbd',
diff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py
index 485f661..837adc9 100755
--- a/nova/virt/libvirt/driver.py
+++ b/nova/virt/libvirt/driver.py
@@ -151,6 +151,7 @@ libvirt_opts = [
                   'fake=nova.virt.libvirt.volume.LibvirtFakeVolumeDriver',
                   'rbd=nova.virt.libvirt.volume.LibvirtNetVolumeDriver',
                   'sheepdog=nova.virt.libvirt.volume.LibvirtNetVolumeDriver',
+                  'hlfs=nova.virt.libvirt.volume.LibvirtNetVolumeDriver',
                   'nfs=nova.virt.libvirt.volume.LibvirtNFSVolumeDriver'
                   ],
                 help='Libvirt handlers for remote volumes.'),
-- 
1.7.9.5

